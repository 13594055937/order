if (typeof jQuery == "undefined") {
    throw new Error("丢失jQuery库文件");
}

/*======================
 * common
 */
+ function($) {
    $.extend({
        // 初始化
        init: function() {
            // 缓存地址
            $.callUrl();

            // console 信息
            console.log("一张网页，要经历怎样的风雨，才能出现在你的面前？\n一位新人，要历经怎样的成长，才能立与技术之巅？\n探寻这里的秘密；\n体验这里的挑战；\n成为这里的主人；\n加入121店，分享你的价值；\n相信,因为多了个你，世界可以有所改变。\n");
            console.log("请将简历发送至 %c xxx@yl.com（ 邮件标题请以“姓名-应聘XX职位-来自console”命名）", "color:#fb6149");
            console.log("职位介绍：http://www.yl.com");
        },
        krLoading: function() {
            $('body').append('<div class="spinner-box clearfix"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></div>');
        },
        krLoadingClose: function() {
            $('.spinner-box').remove();
        },
        krAjax: function(type, url, data, call) {
            var datas = $.extend({

            }, data);
            $.krLoading();
            $.ajax({
                type: type,
                url: url,
                dataType: 'json',
                data: datas
            }).done(function(res) {
                $.krLoadingClose();
                call(res);
            }).fail(function() {
                $.krLoadingClose();
                $.krPopupTip('链接服务器失败');
            });
        },
        // 跨域
        jsonP: function(url, data, call) {
            data = $.extend({}, data);

            $.when(
                $.ajax({
                    url: url,
                    type: 'get',
                    dataType: 'jsonp',
                    data: data
                })
            ).done(function(res) {
                call(res);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                $.krPopupTip('链接服务器失败:' + errorThrown);
            });
        },

        // 常用正则
        regCheck: {
            def: function(reg, str) {
                return reg.test(str);
            },
            userName: function(str) {
                var reg = /^[_A-Za-z0-9]{6,16}$/;
                return reg.test(str);
            },
            psw: function(str) {
                var reg = /^[\w~!@#$%^&*()_+{}:"<>?\-=[\];\',.\/A-Za-z0-9]{6,16}$/;
                return reg.test(str);
            },
            email: function(str) {
                var reg = /^([a-zA-Z0-9]|[._])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;
                return reg.test(str);
            },
            telNum: function(str) {
                var reg = /^((0\d{2,3}-\d{7,8})|(1[3|5|4|7|8][0-9]\d{8}))$/;
                return reg.test(str);
            },
            mobile: function(str) {
                var reg = /^(1[3|4|5|7|8][0-9]\d{8})$/;
                return reg.test(str);
            },
            verify: function(str) {
                var reg = /^\d{6}$/;
                return reg.test(str);
            },
            id: function(str) {
                var reg = /^\d{4}$/;
                return reg.test(str);
            },
            CN: function(str) {
                var reg = /^[\u4E00-\u9FA5]+$/;
                return reg.test(str);
            }
        },

        // 手机格式化
        mobileFormat: function(phoneNum) {
            phoneNum = phoneNum.substring(0, 3) + "****" + phoneNum.substring(7);
            return phoneNum;
        },
        // 浏览器尺寸改变函数
        screenResize: function(fn) {
            fn();
            $(window).on('resize', function() {
                fn();
            });
        },
        setHeight: function(obj, num, scale) {
            var w = parseInt($(window).width());
            $(obj).height(parseInt((w - num) * scale));
        }
    });

    $.extend({
        // 获取关键字值
        getUrlPara: function(key) {
            var paras = window.location.search;
            if (paras) {
                var items = paras.split('?')[1].split('&'),
                    len = items.length,
                    i = 0;
                obj = {};
                for (; i < len; i++) {
                    var item = items[i].split('='),
                        name = item[0],
                        value = item[1] ? item[1] : '';
                    obj[name] = value;
                }
                if (!key) {
                    return obj;
                } else {
                    return obj[key];
                }
            }
        },

        // 获取参数
        getUrlPath: function(ind) {
            var path = window.location.pathname;
            if (path) {
                var paras = path.split('/'),
                    len = paras.length,
                    i = 0,
                    res = [];
                for (; i < len; i++) {
                    if (paras[i]) {
                        res.push(paras[i]);
                    }
                }
                if (typeof ind == 'undefined') {
                    return res[res.length - 1];
                } else {
                    return res[ind];
                }
            } else {
                return '';
            }
        },
        callUrl: function() {
            var prevUrl = window.sessionStorage.getItem('prevUrl');
            var curUrl = window.sessionStorage.getItem('curUrl');
            var localUrl = window.location.href;
            if (!prevUrl) {
                window.sessionStorage.setItem('prevUrl', localUrl);
                window.sessionStorage.setItem('curUrl', localUrl);
            } else {
                if (curUrl !== localUrl) {
                    window.sessionStorage.setItem('prevUrl', curUrl);
                    window.sessionStorage.setItem('curUrl', localUrl);
                }
            }
        },
        goBack: function() {
            return window.sessionStorage.getItem('prevUrl');
        }
    });

    $.fn.extend({
        // 图片滚动加载
        lazyLoad: function() {
            var here = this;
            var winHeight = parseFloat($(window).height());

            function showImg() {
                $(here).each(function() {
                    var imgH = $(this).height(),
                        topVal = $(this).get(0).getBoundingClientRect().top;
                    if ((topVal < (winHeight - (imgH / 3))) && $(this).hasClass('lazy')) {
                        var _here = this;
                        var _img = new Image();
                        _img.src = $(_here).data('original');
                        $(_here).attr('data-original', 0);
                        $(_here).removeClass('lazy');
                        // _img.onload = function(){
                        $(_here).hide().attr('src', _img.src).show();
                        // }
                    }
                });
            }
            showImg();
            $(window).on('scroll', function() {
                showImg();
            });
        },
        statusChange: function(status) {
            if (!$(this).attr('data-default-text')) {
                $(this).attr('data-default-text', $(this).text());
            }
            if (status == 'loading') {
                $(this).text($(this).attr('data-loading-text'));
                $(this).attr('disabled', true).addClass('disabled');
            }
            if (status == 'reset') {
                $(this).text($(this).attr('data-default-text'));
                $(this).attr('disabled', false).removeClass('disabled');
            }
        },
        selectDate:function(options){
            var defaults = {
                fYear:  '.form-select[name="year"]',
                fMonth: '.form-select[name="month"]',
                fDay:   '.form-select[name="day"]'
            };
            var opts = $.extend({}, defaults, options);
            return this.each(function(){
                var iYear = 1945,
                    iMonth = 1,
                    iDay = 1,
                    totalDay = 31,
                    date = new Date();
                    i = date.getFullYear();

                var dataYear = '';
                    dataMonth = '';
                    dataDay = '';
                var year_select = $("#year").attr("value");
                var month_select = $("#month").attr("value");
                var day_select = $("#day").attr("value");
		console.log(year_select)
                // 年
                for(i; i >= iYear; i--){
                    if( i == new Date().getFullYear() ){
                        dataYear += '<option value="'+ i +'" selected>' + i + '</option>';
                    }else{
                        if(i == year_select){
                            dataYear += '<option value="'+ i +'" selected=true>' + i + '</option>';  
                        }else{
                            dataYear += '<option value="'+ i +'">' + i + '</option>';
                        }
                    }
                }
                $(opts.fYear).html(dataYear);

                // 月份
                for(iMonth; iMonth < 13; iMonth++){
                    if(iMonth == month_select){
                        dataMonth += '<option value="'+ iMonth +'" selected=true>'+ iMonth +'</option>';  
                    }else{
                        dataMonth += '<option value="'+ iMonth +'">'+ iMonth +'</option>';
                    }
                    
                }
                $(opts.fMonth).html(dataMonth);

                // 天数
                for(iDay; iDay <= totalDay; iDay++){
                    if(iDay == day_select){
                        dataDay += '<option value="'+ iDay +'" selected=true>'+ iDay +'</option>';  
                    }else{
                        dataDay += '<option value="'+ iDay +'">'+ iDay +'</option>';
                    }
                }
                $(opts.fDay).html(dataDay);

                // 天数根据年和月份过滤
                $(opts.fYear).on('change', function(){

                    $(opts.fMonth).trigger('change');
                });
                $(opts.fMonth).on('change', function(){
                    var curYear = $.trim($(opts.fYear).val()),
                        curMonth = $.trim($(opts.fMonth).val()),
                        iDay = 1,
                        dataDay = '';
                    console.log(curMonth);
                    switch(curMonth){
                        case "1":
                        case "3":
                        case "5":
                        case "7":
                        case "8":
                        case "10":
                        case "12": totalDay = 31; break;
                        case "4":
                        case "6":
                        case "9":
                        case "11": totalDay = 30; break;
                        case "2":
                            // 闰年
                            if( (curYear % 4 == 0 && curYear % 100 != 0) || curYear % 400 == 0 ){
                                totalDay = 29;
                            }else{
                                totalDay = 28;
                            }
                    }

                    console.log(totalDay);

                    // 天数
                    for(iDay; iDay <= totalDay; iDay++){
                        dataDay += '<option value="'+ iDay +'">'+ iDay +'</option>';
                    }
                    $(opts.fDay).html(dataDay);
                });
            });
        },
        citySelect: function(settings){
            /*
                Ajax 三级省市联动

                settings 参数说明
                -----
                url:省市数据josn文件路径
                prov:默认省份
                city:默认城市
                dist:默认地区（县）
                nodata:无数据状态
                required:必选项
            ------------------------------ */
            if(this.length<1){return;};

            // 默认值
            settings=$.extend({
                url:"/Public/js/city.min.json",
                prov:$("#prov_value").val(),
                city:$("#city_value").val(),
                dist:$("#dist_value").val(),
                nodata:null,
                required:true
            },settings);

            var box_obj=this;
            var prov_obj=box_obj.find(".prov");
            var city_obj=box_obj.find(".city");
            var dist_obj=box_obj.find(".dist");
            var prov_val=settings.prov;
            var city_val=settings.city;
            var dist_val=settings.dist;
            var select_prehtml=(settings.required) ? "" : "<option value=''>请选择</option>";
            var city_json;

            // 赋值市级函数
            var cityStart=function(){
                var prov_id=prov_obj.get(0).selectedIndex;
                if(!settings.required){
                    prov_id--;
                };
                city_obj.empty().attr("disabled",true);
                dist_obj.empty().attr("disabled",true);

                if(prov_id<0||typeof(city_json.citylist[prov_id].c)=="undefined"){
                    if(settings.nodata=="none"){
                        city_obj.css("display","none");
                        dist_obj.css("display","none");
                    }else if(settings.nodata=="hidden"){
                        city_obj.css("visibility","hidden");
                        dist_obj.css("visibility","hidden");
                    };
                    return;
                };

                // 遍历赋值市级下拉列表
                temp_html=select_prehtml;
                $.each(city_json.citylist[prov_id].c,function(i,city){
                    temp_html+="<option value='"+city.n+"'>"+city.n+"</option>";
                });
                city_obj.html(temp_html).attr("disabled",false).css({"display":"","visibility":""});
                distStart();
            };

            // 赋值地区（县）函数
            var distStart=function(){
                var prov_id=prov_obj.get(0).selectedIndex;
                var city_id=city_obj.get(0).selectedIndex;
                if(!settings.required){
                    prov_id--;
                    city_id--;
                };
                dist_obj.empty().attr("disabled",true);

                if(prov_id<0||city_id<0||typeof(city_json.citylist[prov_id].c[city_id].a)=="undefined"){
                    if(settings.nodata=="none"){
                        dist_obj.css("display","none");
                    }else if(settings.nodata=="hidden"){
                        dist_obj.css("visibility","hidden");
                    };
                    return;
                };

                // 遍历赋值市级下拉列表
                temp_html=select_prehtml;
                $.each(city_json.citylist[prov_id].c[city_id].a,function(i,dist){
                    temp_html+="<option value='"+dist.s+"'>"+dist.s+"</option>";
                });
                dist_obj.html(temp_html).attr("disabled",false).css({"display":"","visibility":""});
            };

            var init=function(){
                // 遍历赋值省份下拉列表
                temp_html=select_prehtml;
                $.each(city_json.citylist,function(i,prov){
                    temp_html+="<option value='"+prov.p+"'>"+prov.p+"</option>";
                });
                prov_obj.html(temp_html);

                // 若有传入省份与市级的值，则选中。（setTimeout为兼容IE6而设置）
                setTimeout(function(){
                    if(settings.prov!=null){
                        prov_obj.val(settings.prov);
                        cityStart();
                        setTimeout(function(){
                            if(settings.city!=null){
                                city_obj.val(settings.city);
                                distStart();
                                setTimeout(function(){
                                    if(settings.dist!=null){
                                        dist_obj.val(settings.dist);
                                    };
                                },1);
                            };
                        },1);
                    };
                },1);

                // 选择省份时发生事件
                prov_obj.bind("change",function(){
                    cityStart();
                });

                // 选择市级时发生事件
                city_obj.bind("change",function(){
                    distStart();
                });
            };

            // 设置省市json数据
            if(typeof(settings.url)=="string"){
                $.getJSON(settings.url,function(json){
                    city_json=json;
                    init();
                });
            }else{
                city_json=settings.url;
                init();
            };
        }
    });
    $.init();
}(jQuery);


/* ==================
 * krPopup
 *
 */
+ function($) {
    $.krPopup = function(options) {
        var defaults = {
                skin: 'krPopup',
                width: 260,
                titleShow: false,
                titleTxt: '提示',
                content: '<div class="only-txt">欢迎来到野驴</div>',
                mask: true,
                zIndex: 1000,
                closeShow: false,
                closeCall: function() {
                    $.krPopupClose(opts.skin);
                },
                buttons: [
                    ['取消', 'button button-md button-full button-cancel', function() {
                        $.krPopupClose();
                    }],
                    ['确定', 'button button-md button-full button-confirm', function() {
                        $.krPopupClose();
                    }]
                ]
            },
            opts = $.extend({}, defaults, options),
            str = '';
        // 判断蒙层是否显示
        if (opts.mask) {
            str += '<div id="krPopupMask" style="z-index:' + opts.zIndex + '"></div>';
        }

        // 弹层
        str += '<div class="krPopup" id="' + opts.skin + '" style="z-index:' + (opts.zIndex + 1) + ';">';

        // 关闭按钮
        if (opts.closeShow) {
            str += '<span class="popup-close">&times;</span>';
        }

        // 标题
        if (opts.titleShow) {
            str += '<div class="popup-hd"><h3>' + opts.titleTxt + '</h3></div>';
        }
        // 主体
        str += '<div class="popup-bd">' + opts.content + '</div>';
        if (opts.buttons && opts.buttons.length) {
            str += '<div class="popup-buttons-box clearfix">';
            for (var i = 0; i < opts.buttons.length; i++) {
                if (opts.buttons.length == 1) {
                    if (opts.buttons[i][0] && opts.buttons[i][1]) {
                        str += '<span class="col-12 g-tac"><span class="' + opts.buttons[i][1] + '">' + opts.buttons[i][0] + '</span></span>';
                    } else {
                        $.krPopupTip('请联系客服');
                    }
                }
                if (opts.buttons.length == 2) {
                    if (opts.buttons[i][0] && opts.buttons[i][1]) {
                        str += '<span class="col-6 g-tac"><span class="' + opts.buttons[i][1] + '">' + opts.buttons[i][0] + '</span></span>';
                    } else {
                        $.krPopupTip('请联系客服');
                    }
                }
            }
            str += '</div>';
        }
        str += '</div>';
        $(str).appendTo('body');

        // 针对弹层的位置进行处理
        var $top = parseInt($('.krPopup').height() / 2);
        $('.krPopup').css({
            marginTop: -$top + 'px'
        });

        // 关闭弹层
        $('.krPopup').on('click', '.popup-close', function() {
            if (typeof opts.closeCall === 'function') {
                opts.closeCall();
            }
        });
        $('.krPopup').on('click', '.popup-buttons-box .g-tac', function() {
            var ind = $(this).index();
            if (typeof opts.buttons[ind][2] === 'function') {
                opts.buttons[ind][2]();
            }
        });

        return this;
    };
    $.krPopupClose = function(id) {
        $('#krPopupMask').remove();
        $('.krPopup').remove();
    };
    $.krPopupHide = function(id) {
        $('#krPopupMask').fadeOut();
        $('.krPopup').fadeOut();
    };
    $.krPopupShow = function(id) {
        $('#krPopupMask').fadeIn();
        $('.krPopup').fadeOut();
    };
    $.krPopupTip = function(msg, closeShow, fn) {
        $.krPopup({
            titleShow: false,
            closeShow: closeShow ? closeShow : false,
            buttons: [],
            content: '<div class="popup-tip">' + (msg ? msg : 'Error') + '</div>'
        });
        $('.krPopup .popup-close').css({
            'color': '#fff',
            'font-size': '18px',
            'line-height': '38px'
        });
        var timer = setTimeout(function() {
            $('#krPopup').fadeOut(200, function() {
                $.krPopupClose('krPopup');
                clearTimeout(timer);
                if (typeof fn === 'function') {
                    fn();
                }
            });
        }, 1500);
    };
}(jQuery);
