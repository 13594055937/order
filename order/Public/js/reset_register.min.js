function Index() {
    this.init();
}

Index.prototype = {
    init: function() {
        this.bindDOM();
    },
    bindDOM: function() {
        $('.reg-step-cont .button-step').on('click', function() {
            var self = $(this);
            if (self.hasClass('button-step-one')) {
                var type = self.attr('data-type');
                var data = {
                    name: $.trim($('#userMobile').val()),
                    msgCode: $.trim($('#msgCode').val()),
                };
                self.statusChange('loading');

                // 帐号
                if (!data.name || !$.regCheck.mobile(data.name)) {
                    alert('手机号码格式有填错');
                    setTimeout(function() {
                        self.statusChange('reset');
                    }, 1000);
                    return false;
                }

                // 验证码
                if (!data.msgCode || !$.regCheck.verify(data.msgCode)) {
                    alert('验证码有填错');
                    setTimeout(function() {
                        self.statusChange('reset');
                    }, 1000);
                    return false;
                }

                var url = $("#reg_url").html()
                $.ajax({
                  'url'  :url,
                  'data'   :{'yanzhengma':data.msgCode},
                  'type'   :'post',
                  'success':function(msg){
                    if(msg!="success"){
                        alert('短信验证码有填错');
                        self.statusChange('reset');
                        return false;
                    }else{
                        $('.reg-step-title').find('.step-title-' + type).addClass('current').siblings('.step-name').removeClass('current');
                        $('.step-cont-' + type).addClass('current').siblings('.reg-step-cont').removeClass('current');
                    }
                  }
                })
            } else if (self.hasClass('button-step-two')) {
                var type = self.attr('data-type');
                var data = {
                    msgCode: $.trim($('#msgCode').val())
                };
                self.statusChange('loading');

                // 短信验证码
                if (!data.msgCode || !$.regCheck.verify(data.msgCode)) {
                    alert('短信验证码有填错');
                    setTimeout(function() {
                        self.statusChange('reset');
                    }, 1000);
                    return false;
                }

                $('.reg-step-title').find('.step-title-' + type).addClass('current').siblings('.step-name').removeClass('current');
                $('.step-cont-' + type).addClass('current').siblings('.reg-step-cont').removeClass('current');
            } else if (self.hasClass('button-step-three')) {
                var type = self.attr('data-type');
                var data = {
                    setPsw: $.trim($('#setPsw').val()),
                    confirmPsw: $.trim($('#confirmPsw').val())
                };

                self.statusChange('loading');

                // 密码格式不正确
                if (!data.setPsw || !$.regCheck.psw(data.setPsw)) {
                    alert('密码格式不正确');
                    setTimeout(function() {
                        self.statusChange('reset');
                    }, 1000);
                    return false;
                }

                // 两次密码不一致
                if (!data.confirmPsw || data.confirmPsw != data.setPsw) {
                    alert('两次密码不一致');
                    setTimeout(function() {
                        self.statusChange('reset');
                    }, 1000);
                    return false;
                }
                var url = $("#edit_pwd_url").html()
                $.ajax({
                  'url'  :url,
                  'data'   :{'phone':$.trim($('#userMobile').val()),'pwd':data.setPsw},
                  'type'   :'post',
                  'success':function(msg){
                    if(msg!="success"){
                        alert('密码修改失败');
                        self.statusChange('reset');
                        return false;
                    }else{
                        $('.reg-step-title').find('.step-title-' + type).addClass('current').siblings('.step-name').removeClass('current');
                        $('.step-cont-' + type).addClass('current').siblings('.reg-step-cont').removeClass('current');
                    }
                  }
                })
            }
        });
		
    }
}

$(function() {
	var timeout;
    var count = 60; // 倒数十下
    var url = $("#reg_url").html();
    BtnCount = function() {
      console.log(11)
           // 启动按钮
        if (count == 0) {
            $('.get-msgCode').removeAttr("disabled");
            $('.get-msgCode').html("发送验证码");
            clearTimeout(timeout);           // 可取消由 setTimeout() 方法设置的 timeout
        }
        else {
            count--;
            $('.get-msgCode').html("已发送，剩余 "+count.toString()+" 秒");
            setTimeout(BtnCount, 1000);
        }
    };
    $('.get-msgCode').on('click', function() {
          var phone = $("#userMobile").val();
          var reg = /^1[3458]\d{9}$/;
          if(!reg.test($.trim(phone)) || phone=="")
          {
           alert("手机号码格式不对！");
           return false;
          }
          $.ajax({
              'url':    url  ,
              'data'   :{"phone":phone,"action":"reset_pwd"},
              'type'   :'post',
              'success':function(msg){
                  if(msg.length >6){
                    alert(msg);
                  }else{
                    count = 60;
                    $('.get-msgCode').attr("disabled", "true");
                    timeout = setTimeout(BtnCount, 1000);
                  }
              }
            })
        $('#msgCode').focus();
    });
    new Index();
});
